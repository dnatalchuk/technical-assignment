<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Event Feed</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 40px auto;
        text-align: center;
      }
      h1 {
        margin-top: 0;
      }
      #controls {
        margin-bottom: 10px;
      }
      #events {
        border: 1px solid #ccc;
        height: 200px;
        overflow-y: auto;
        padding: 0;
        list-style: none;
      }
      #events li {
        padding: 4px;
        border-bottom: 1px solid #eee;
      }
      .highlight {
        background-color: #ffffcc;
        transition: background-color 1s ease;
      }
    </style>
  </head>
  <body>
    <h1>Real-Time Event Feed</h1>
    <div id="controls">
      <label>
        Tenant:
        <select id="tenant">
          <option value="tenantA">Tenant A</option>
          <option value="tenantB">Tenant B</option>
        </select>
      </label>
      <button id="connect">Connect</button>
      <span id="status"></span>
    </div>
    <ul id="events"></ul>
    <form id="eventForm">
      <input type="text" id="message" placeholder="message" required />
      <button type="submit">Send</button>
    </form>
    <script>
      let ws;
      let tenant;
      const pending = new Map();
      const MAX_EVENTS = 100;
      const eventsList = document.getElementById("events");

      document.getElementById("connect").onclick = () => {
        tenant = document.getElementById("tenant").value;
        ws = new WebSocket(`ws://${location.host}/ws?tenant=` + tenant);
        ws.onmessage = (e) => {
          const ev = JSON.parse(e.data);
          const li = document.createElement("li");
          const ts = new Date(ev.timestamp).toLocaleTimeString();
          let text = `${ts} - ${ev.message}`;
          if (pending.has(ev.id)) {
            const dur = Math.round(pending.get(ev.id));
            pending.delete(ev.id);
            text += ` (took ${dur} ms)`;
          }
          li.textContent = text;
          li.classList.add("highlight");
          eventsList.appendChild(li);
          setTimeout(() => li.classList.remove("highlight"), 1000);
          eventsList.scrollTop = eventsList.scrollHeight;
          if (eventsList.children.length > MAX_EVENTS) {
            eventsList.removeChild(eventsList.firstChild);
          }
        };
        ws.onopen = () => {
          document.getElementById("status").textContent = "connected";
        };
        ws.onclose = () => {
          document.getElementById("status").textContent = "closed";
        };
      };

      document.getElementById("eventForm").onsubmit = async (e) => {
        e.preventDefault();
        const message = document.getElementById("message").value;
        const start = performance.now();
        const resp = await fetch("/events", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Tenant-ID": tenant,
          },
          body: JSON.stringify({ message }),
        });
        const data = await resp.json();
        pending.set(data.id, performance.now() - start);
        document.getElementById("message").value = "";
      };
    </script>
  </body>
</html>
